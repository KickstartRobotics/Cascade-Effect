#pragma config(Hubs,  S1, HTMotor,  HTMotor,  none,     none)
#pragma config(Hubs,  S2, HTServo,  none,     none,     none)
#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
#pragma config(Sensor, S2,     ,               sensorI2CMuxController)
#pragma config(Motor,  motorA,           ,             tmotorNXT, openLoop)
#pragma config(Motor,  motorB,           ,             tmotorNXT, openLoop)
#pragma config(Motor,  motorC,           ,             tmotorNXT, openLoop)
#pragma config(Motor,  mtr_S1_C1_1,     driveRight,    tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C1_2,     driveLeft,     tmotorTetrix, openLoop, reversed)
#pragma config(Motor,  mtr_S1_C2_1,     scissorLifter, tmotorTetrix, openLoop, reversed)
#pragma config(Motor,  mtr_S1_C2_2,     ballLifter,   tmotorTetrix, openLoop)
#pragma config(Servo,  srvo_S2_C1_1,    goalServo,            tServoStandard)
#pragma config(Servo,  srvo_S2_C1_2,    bucketServo,          tServoStandard)
#pragma config(Servo,  srvo_S2_C1_3,    servo3,               tServoNone)
#pragma config(Servo,  srvo_S2_C1_4,    servo4,               tServoNone)
#pragma config(Servo,  srvo_S2_C1_5,    servo5,               tServoNone)
#pragma config(Servo,  srvo_S2_C1_6,    servo6,               tServoNone)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

//#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
//#pragma config(Sensor, S2,     ,               sensorI2CMuxController)
//#pragma config(Motor,  mtr_S1_C2_1,     beltMotor,     tmotorTetrix, openLoop)
//#pragma config(Motor,  mtr_S1_C2_2,     liftMotor,     tmotorTetrix, openLoop)

//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

//*Includes*//
#pragma debuggerWindows("joystickGame");
#include "JoystickDriver.c" //Include file to "handle" the Bluetooth messages.

//*Controller Constants*//
const int BUTTONX  			= 1;
const int BUTTONA 		  = 2;
const int BUTTONB       = 3;
const int BUTTONY  			= 4;
const int BUTTONLB 			= 5;
const int BUTTONRB 			= 6;
const int BUTTONLT 			= 7;
const int BUTTONRT 			= 8;

//*Motor constants*//
const int MAXPOWER			     = 100;
const int THREEQUARTERSPOWER = 75;
const int HALFPOWER					 = 50;
const int BELTPOWER					 = 15;
const int NOPOWER						 = 0;

//*Global Variables*//
float moveModifier			= 1;
bool shiftSlowMo 				= false;
bool shiftDirection			= false;
bool shiftGoal					= false;

//*Function Prototypes*//
void initializeRobot();
void moveRobot();
void toggleSlow();
void toggleDirection();
void toggleGoalMover();
void scissorLift();
void conveyerBelt();



//The main task will run the robot initialization and then will wait for the signal from FCS
//to begin and enter the continuous loop that recieves joystick values and executes functions
//with this data.
task main()
{
  initializeRobot();   //Sets servos into starting positions

  waitForStart();   // Waits for start of tele-op phase
  while ( true )
  {

  	//Updates joystick variables with data from joystick station
		getJoystickSettings( joystick );
		moveRobot();
		toggleSlow();
		toggleDirection();
		toggleGoalMover();
		scissorLift();
		conveyerBelt();
  }
}
//*Functions*//

//Sets all values and servos prior to the start of the telop mode.
void initializeRobot()
{
	servo[ goalServo ] = 250; //Initializes servo to start position
	servo[ bucketServo ] = 0;
	}

//Recieves joystick data from controllers then modifies that value
//and sets the motor equal to the modified value.
void moveRobot()
{
	//Sanitize low values from the joysticks
	if( abs( joystick.joy1_y1 ) < 5 && abs( joystick.joy1_y2 ) < 5 )
	{
		motor[ driveLeft ]	=	NOPOWER;
		motor[ driveRight ]	=	NOPOWER;
	}
	else if( moveModifier > 0 )
	{
		motor[ driveRight ]	= joystick.joy1_y2 / moveModifier;
		motor[ driveLeft ]	= joystick.joy1_y1 / moveModifier;
	}
	else
	{
		motor[ driveRight ]	= joystick.joy1_y1 / moveModifier;
		motor[ driveLeft ]	= joystick.joy1_y2 / moveModifier;
	}
}

void toggleSlow()
{
	if( joy1Btn( BUTTONA ) || joy2Btn( BUTTONA ) )
	{
		if( !shiftSlowMo && abs( moveModifier ) == 1 )
		{
			moveModifier *= 5; //divides the input of controllers to motors by 5
		}

		else if( !shiftSlowMo && abs( moveModifier ) > 1 )
		{
			moveModifier /= 5; //changes the input of controllers to motors back to 1
		}
		shiftSlowMo = true;
	}
	else
	{
		shiftSlowMo = false;
	}
}

void toggleDirection()
{
	if( joy1Btn( BUTTONY ) || joy2Btn( BUTTONY ) )
	{
		if( !shiftDirection )
		{
			moveModifier *= -1; //changes the controller input to the motors to the oppisite of what it is
		}
		shiftDirection = true;
	}
	else
	{
			shiftDirection = false;
	}
}

void toggleGoalMover()
{
	if( joy1Btn( BUTTONB ) )
	{
		int upPosition = 250;
		int downPosition = 40;

		if( !shiftGoal && ServoValue[ goalServo ] != downPosition )
		{
			servo[ goalServo ] = downPosition;
		}
		else if( !shiftGoal && ServoValue[ goalServo ] != upPosition )
		{
			servo[ goalServo ] = upPosition;
		}
		shiftGoal = true;
	}
	else
	{
		shiftGoal = false;
	}
}

void scissorLift()
{
	if( abs( joystick.joy2_y1 ) < 5 )
	{
		motor[ scissorLifter ]	=	NOPOWER;
	}
	else
	{
		motor[ scissorLifter ]	= joystick.joy2_y1 *= -1;
	}
	if ( joy2Btn( BUTTONB ) )
	{
	servo[ bucketServo ] = 60;
	}
	else if ( joy2Btn( BUTTONX ) )
	{
	servo[ bucketServo ] = 0;
	}
}

void conveyerBelt()
{
	if( abs( joystick.joy2_y2 ) < 5 )
	{
		motor[ ballLifter ]	=	NOPOWER;
	}
	else
	{
		motor[ ballLifter ]	= joystick.joy2_y2;
	}
}
